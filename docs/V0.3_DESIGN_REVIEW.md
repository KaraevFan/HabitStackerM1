# V0.3 Design Review — Agent-First Intake Implementation

**Date:** 2026-01-24
**Status:** Implementation Complete, Ready for Review
**Reviewer Prompt:** Does this implementation align with product intent? What feels off?

---

## What Was Built

V0.3 delivers the complete end-to-end flow from conversational intake to daily runtime loop:

```
Chat Intake → Confirmation Screen → First Rep → Plan Screen → Today → Done/Miss → Recovery
```

### User Journey (Happy Path)

1. **User opens `/setup`** → Sees chat interface with agent greeting
2. **Discovery conversation** (3-6 turns) → Agent asks contextual questions, offers suggested response pills
3. **Reflection** → Agent summarizes understanding, user confirms/corrects
4. **Recommendation** → Agent presents personalized habit in chat (short message)
5. **User accepts** → Transitions to Confirmation Screen
6. **Confirmation Screen** → Shows habit card, "Why this fits you," recovery action
7. **"Felt understood" rating** → User rates 1-5 how well agent understood them
8. **First rep CTA** → User starts first rep (or defers)
9. **Plan Screen** (`/`)→ Shows contract, reps count, "Start today's rep" button
10. **Today** (`/today`) → Execute habit, mark Done or Missed
11. **If missed** → Next visit forces Recovery (`/recovery`)
12. **Recovery complete** → Returns to Active state

---

## Architecture Decisions

### Single Agent (Not Two)

**PRD proposed:** Two agents (Intake Agent + Recommendation Agent)

**What we built:** Single agent handles entire conversation arc

**Rationale:**
- Recommendation felt jarring when it came from a "different voice"
- Single agent maintains conversational continuity
- Simpler implementation, fewer failure modes
- Agent naturally transitions through phases: `discovery → reflection → recommendation → refinement → ready_to_start`

**Trade-off:** Agent prompt is more complex, but conversation feels more cohesive.

---

### Confirmation Screen (Separate from Chat)

**Alternative considered:** Keep everything in chat (recommendation + confirmation inline)

**What we built:** Chat handles conversation, separate Confirmation Screen for final acceptance

**Rationale:**
- Chat messages are intentionally short (2-3 sentences)
- Full habit details (anchor, action, whyItFits bullets, recovery) need more space
- Separate screen creates a "moment" for the decision
- Clean place to collect "felt understood" rating

**Components created:**
- `ConfirmationScreen.tsx` — Container with rating + CTAs
- `HabitCard.tsx` — Displays full recommendation details
- `FeltUnderstoodRating.tsx` — 1-5 rating buttons

---

### Phase-Based Conversation (Not Checklist)

**PRD described:** Agent collects goal, blocker, timing, history, context

**What we built:** Agent exits when confident in hypothesis, not when checklist complete

**Phases:**
| Phase | Purpose | Typical Turns |
|-------|---------|---------------|
| `discovery` | Understand situation | 2-4 |
| `reflection` | Confirm understanding | 1 |
| `recommendation` | Present habit | 1 |
| `refinement` | Handle pushback (if any) | 0-2 |
| `ready_to_start` | User accepted | — |

**Key behavior:** Agent forms a hypothesis about the *real* leverage point (which may differ from user's stated goal) and recommends based on that insight.

---

### Model Selection

| Component | Model | Rationale |
|-----------|-------|-----------|
| Intake Agent | Claude Sonnet | Highest-leverage moment; message quality matters |
| Fallback | OpenAI GPT-4o | If Anthropic unavailable |
| Runtime screens | None (static) | No AI needed for Done/Miss/Recovery |

**Note:** Intake prompt was validated with Sonnet. Quality degrades noticeably with other models.

---

## Response Schema

```typescript
interface IntakeAgentResponse {
  message: string;                              // Chat message (2-3 sentences typical)
  suggestedResponses: string[] | null;          // Pill options for quick responses
  phase: 'discovery' | 'reflection' | 'recommendation' | 'refinement' | 'ready_to_start';
  hypothesis: string | null;                    // Agent's theory about real leverage
  habitRecommendation: HabitRecommendation | null;  // Structured recommendation
}

interface HabitRecommendation {
  anchor: string;       // "After brushing teeth at night"
  action: string;       // "Put phone on charger in kitchen"
  followUp?: string;    // Optional follow-up action
  whyItFits: string[];  // Personalized reasons (3-4 bullets)
  recovery: string;     // "Touch phone charger for 5 seconds"
}
```

---

## State Transitions

### Habit States

```
install → designed → active → missed → active (via recovery)
```

| Event | State Change | Side Effects |
|-------|--------------|--------------|
| Complete setup (first rep) | `install → active` | repsCount = 1, lastDoneDate = today |
| Complete setup (defer) | `install → designed` | — |
| Mark Done | stays `active` | repsCount++, lastDoneDate = today |
| Mark Missed | `active → missed` | missedDate = today |
| Recovery Done | `missed → active` | repsCount++, lastDoneDate = today |
| Recovery Skip | stays `missed` | Event logged |

### Routing Logic

- `/` checks state:
  - `install` → redirect to `/setup`
  - `missed` → redirect to `/recovery`
  - `designed` or `active` → show Plan Screen

---

## Chat UI Details

### Message Display
- User messages: right-aligned, blue background
- Assistant messages: left-aligned, gray background
- Typing indicator while waiting for response

### Suggested Response Pills
- Horizontal scroll below assistant message
- Click → sends message immediately
- Always visible input for custom responses

### Escape Hatch
- After 3+ turns, shows "I think you understand" button
- Triggers `forceRecommend` — agent skips to recommendation with current hypothesis
- Framing: validates agent's understanding (not "skip")

---

## Data Persistence

### localStorage Keys

| Key | Content |
|-----|---------|
| `habit-stacker-data` | HabitData (state, planDetails, snapshot, events, intakeState) |
| `habit-stacker-conversation` | IntakeState during setup (cleared on completion) |

### What's Preserved

After setup completion, `HabitData.intakeState` contains:
- Full message history
- Final recommendation
- `feltUnderstoodRating` (1-5)
- Completion timestamp

This enables thesis validation: correlate "felt understood" ratings with completion rates.

---

## Product Law Compliance

| Law | Implementation |
|-----|----------------|
| **One active habit** | Single habit in HabitData, no multi-habit support |
| **Miss is first-class** | Miss → state change → forced recovery on next visit |
| **No streak framing** | UI shows "Reps" and "Last done", never "streak" |
| **One clear CTA** | Each screen has single dominant action |
| **Progressive disclosure** | No tuning until 3+ reps (not implemented yet, but no tuning UI exists) |

### Forbidden Language Check
- No instances of: streak, failure, discipline, lazy, shame
- Recovery copy: "Missing happens. What matters is getting back on track quickly."

---

## What's NOT Built Yet

### From PRD/M1 Requirements

| Feature | Status | Notes |
|---------|--------|-------|
| Streaming responses | Not implemented | Returns complete responses |
| "Show alternatives" flow | Not implemented | User can ask in chat, but no dedicated UI |
| Re-entry flow (7+ days inactive) | Logic exists | `needsReentry()` function, no UI |
| Weekly review | Not built | M2/M3 scope |
| Progression mechanics | Not built | M3 scope |

### Known Gaps

1. **No loading skeleton** — Chat area empty until first message
2. **No offline handling** — API failure shows error, no retry queue
3. **No message edit/delete** — Conversation is append-only
4. **Dark mode** — CSS variables exist but not fully styled

---

## Metrics for Thesis Validation

### Primary Metric
**"Felt understood" rating distribution**
- Target: Average ≥ 4.0 out of 5
- Stored in: `HabitData.intakeState.feltUnderstoodRating`

### Secondary Metrics (Manual Tracking for Now)
- Time from start to first rep
- Turn count to recommendation
- "Show alternatives" / pushback rate
- 7-day completion rate (correlate with felt understood)

---

## Open Questions for Review

1. **Confirmation Screen transition** — Does the jump from chat to separate screen feel natural, or should recommendation details stay inline?

2. **Message length** — Are 2-3 sentence responses the right length? Too short? Too long?

3. **Suggested pills** — Are they helpful or do they feel limiting? Should there be more/fewer?

4. **Recovery framing** — "Done — I'm back" vs something else? Does it feel encouraging or patronizing?

5. **Rating placement** — Is asking "How well did I understand?" before first rep the right moment? Or after?

6. **Phase visibility** — Should user see what phase they're in, or keep it invisible?

---

## Files Changed (V0.3)

### New Files
```
src/app/today/page.tsx
src/app/recovery/page.tsx
src/components/confirmation/ConfirmationScreen.tsx
src/components/confirmation/HabitCard.tsx
src/components/confirmation/FeltUnderstoodRating.tsx
src/components/confirmation/index.ts
src/components/chat/ChatContainer.tsx
src/components/chat/ChatMessage.tsx
src/components/chat/ChatInput.tsx
src/components/chat/SuggestedPills.tsx
src/components/chat/TypingIndicator.tsx
src/components/chat/index.ts
src/lib/ai/prompts/intakeAgent.ts
src/lib/ai/useIntakeAgent.ts
src/lib/store/conversationStore.ts
src/types/conversation.ts
src/app/api/intake/route.ts
```

### Modified Files
```
src/app/setup/page.tsx (rewritten for chat flow)
src/app/page.tsx (added recovery redirect)
src/types/habit.ts (added intakeState field)
```

---

## How to Test

### Setup Flow
1. Go to `http://localhost:3000/setup`
2. Complete chat conversation (3-6 turns typical)
3. Accept recommendation → see Confirmation Screen
4. Rate understanding, start first rep
5. Should land on Plan Screen

### Runtime Loop
1. From Plan Screen, click "Start today's rep"
2. Mark Done → should update reps count
3. Mark Missed → next visit should force Recovery
4. Complete Recovery → should return to Active

### Edge Cases
- Refresh during chat → conversation should persist
- Click "I think you understand" early → should get recommendation
- Push back on recommendation → agent should pivot

---

## Summary

V0.3 delivers a working end-to-end flow that tests the core thesis: **Can conversational AI create personalized habit recommendations that feel "made for me"?**

The implementation prioritizes:
- Conversation quality over configuration completeness
- Felt understanding over data collection
- Simple, working flow over feature completeness

Ready for feedback on whether this aligns with product intent.
