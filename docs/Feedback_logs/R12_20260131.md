# Check-In Implementation Feedback

**Date:** 2026-01-31  
**Status:** Requires Revision  
**Priority:** High ‚Äî Core feature not working as designed

---

## Summary

The check-in implementation is partially complete but has two critical gaps that make the feature effectively unreachable and architecturally incomplete:

1. **The intake agent doesn't generate `habitType`** ‚Äî No habits will ever activate the new flow
2. **Time/event habits don't use the new check-in system** ‚Äî Only reactive habits were implemented, but time/event habits should also use the new model

---

## Gap 1: Intake Agent Not Updated

### Problem

The intake agent prompt (`src/lib/ai/prompts/intakeAgent.ts`) was not modified. This means:

- New habits created via conversation have no `habitType` field
- The code checks `habitType === 'reactive'` and falls back to old flow when undefined
- **Result:** 100% of users will never see the new check-in experience

### Required Changes

**A. Update the `HabitRecommendation` interface** to include:

```typescript
interface HabitRecommendation {
  // ... existing fields ...
  
  habitType: 'time_anchored' | 'event_anchored' | 'reactive';
  anchorTime?: string;      // For time-anchored: "21:00"
  checkInTime?: string;     // For reactive: "08:00" (morning check-in)
  principle?: string;       // Behavioral science insight for "Why this works"
  expectations?: string;    // What to expect in first week
}
```

**B. Update the intake agent system prompt** to:

1. **Detect habit type from conversation context:**
   - Time-anchored: "Every day at 9pm" / "Before bed" / "After morning coffee"
   - Event-anchored: "After I brush my teeth" / "When I get home from work"  
   - Reactive: "When I wake up at night" / "When I feel anxious" / "When I get a craving"

2. **Generate appropriate fields based on type:**
   - Time-anchored ‚Üí set `anchorTime`
   - Reactive ‚Üí set `checkInTime` (when to ask "how was last night?")

3. **Generate education content:**
   - `principle`: One sentence of behavioral science (e.g., "Consistent cues build automatic associations faster than willpower")
   - `expectations`: What the first week typically feels like

**C. Add detection guidance to the prompt:**

```markdown
## Determining Habit Type

Analyze the user's situation to determine the habit type:

**Time-anchored** ‚Äî The behavior happens at a predictable time each day
- Cue: Clock time or daily routine moment
- Examples: "Read before bed", "Meditate at 7am", "Journal after dinner"
- Key indicator: User mentions specific times or daily routines

**Event-anchored** ‚Äî The behavior is triggered by completing another action  
- Cue: Completion of an existing habit
- Examples: "After I brush my teeth", "When I sit down at my desk"
- Key indicator: User describes chaining onto existing behavior

**Reactive** ‚Äî The behavior responds to an unpredictable trigger
- Cue: Internal state or external event that doesn't happen daily
- Examples: "When I wake up at 3am", "When I feel anxious", "When I get a craving"
- Key indicator: Trigger may or may not occur on any given day

For M1, default to **time_anchored** if ambiguous. Only use **reactive** when the trigger is clearly unpredictable.
```

---

## Gap 2: Time/Event Habits Bypass New Check-In System

### Problem

The PRD specifies that ALL habits use the new check-in model, with type-specific variations:

| Habit Type | CTA | Options | Data Captured |
|------------|-----|---------|---------------|
| Time/Event | "Mark today's rep" | Done / Can't today / Not yet | triggerOccurred, actionTaken, missReason, difficultyRating |
| Reactive | "Check in on last night" | üåô Slept through / ‚úì Used protocol / ‚úó Stayed in bed | triggerOccurred, actionTaken, outcomeSuccess, missReason |

**Current implementation:** Only reactive habits route through `CheckInFlow`. Time/event habits use the old `logRep()` system, which means they:

- ‚ùå Don't capture `triggerOccurred` 
- ‚ùå Don't get difficulty ratings
- ‚ùå Don't get miss reason capture
- ‚ùå Don't receive whispers
- ‚ùå Don't get recovery offers
- ‚ùå Write to `repLogs` instead of `checkIns` (data model split)

### Required Changes

**A. Create `CheckInOptionsTimeEvent.tsx`** (or extend `CheckInOptions.tsx`):

```typescript
// Before anchor time
const OPTIONS_BEFORE = [
  { id: 'done', label: 'Done', icon: '‚úì' },
  { id: 'not_yet', label: 'Not yet', icon: '‚è≥' },
];

// After anchor time
const OPTIONS_AFTER = [
  { id: 'done', label: 'Done', icon: '‚úì' },
  { id: 'cant_today', label: "Can't today", icon: '‚úó' },
];
```

**B. Update routing logic in `CheckInFlow.tsx`:**

```typescript
// Current (wrong)
if (habitType === 'reactive') {
  return <CheckInOptions ... />
}
// Falls through to old system

// Should be
if (habitType === 'reactive') {
  return <CheckInOptionsReactive ... />
} else {
  return <CheckInOptionsTimeEvent ... />
}
// Both paths continue through success/miss/recovery
```

**C. Update `today/page.tsx` and `PlanScreen.tsx`:**

- Remove the `habitType === 'reactive'` gate
- Route ALL habits through `CheckInFlow`
- Default `habitType` to `'time_anchored'` when undefined (for existing habits)

**D. Deprecate or migrate `repLogs`:**

- Either: Migrate `repLogs` data to `checkIns` format
- Or: Have `logCheckIn()` also write to `repLogs` for backwards compatibility
- Goal: Single source of truth for completion data

---

## Acceptance Criteria

### Intake Agent
- [ ] New habits have `habitType` field set based on conversation
- [ ] Reactive habits detected when trigger is unpredictable (waking at night, cravings, anxiety)
- [ ] Time-anchored habits have `anchorTime` set
- [ ] Reactive habits have `checkInTime` set  
- [ ] `principle` field generated with behavioral science insight
- [ ] `expectations` field generated with first-week guidance

### Check-In Flow (Time/Event Habits)
- [ ] Home screen shows "Mark today's rep" for time/event habits
- [ ] Tapping CTA shows options: Done / Can't today (or Not yet before anchor)
- [ ] "Done" ‚Üí Success screen with whisper + optional difficulty rating
- [ ] "Can't today" ‚Üí Miss screen with reason options + recovery offer
- [ ] All data writes to `checkIns` array with `triggerOccurred: true`

### Check-In Flow (Reactive Habits)  
- [ ] Home screen shows "Check in on last night" for reactive habits
- [ ] Tapping CTA shows 3 options: Slept through / Used protocol / Stayed in bed
- [ ] "Slept through" ‚Üí Success screen (triggerOccurred: false, positive framing)
- [ ] "Used protocol" ‚Üí Success screen (triggerOccurred: true, actionTaken: true)
- [ ] "Stayed in bed" ‚Üí Miss screen (triggerOccurred: true, actionTaken: false)

### Backwards Compatibility
- [ ] Existing habits (no `habitType`) default to `time_anchored` behavior
- [ ] Existing `repLogs` data still accessible (or migrated)

### Whispers & Education
- [ ] First rep triggers congratulatory whisper
- [ ] First miss triggers supportive whisper
- [ ] System screen "Why This Works" shows principle when available

---

## Testing Checklist

1. **New user, time-anchored habit:**
   - Create habit via conversation about "reading before bed"
   - Verify `habitType: 'time_anchored'` in stored data
   - Complete full check-in flow with difficulty rating
   - Verify whisper appears on success screen

2. **New user, reactive habit:**
   - Create habit via conversation about "waking up at night"
   - Verify `habitType: 'reactive'` in stored data
   - Test all three check-in paths (slept through / used protocol / missed)
   - Verify "slept through" is framed positively

3. **Existing user, no habitType:**
   - Load app with existing habit data (no habitType field)
   - Verify defaults to time-anchored behavior
   - Verify check-in flow works normally

---

## Files Requiring Changes

| File | Change Type | Priority |
|------|-------------|----------|
| `src/lib/ai/prompts/intakeAgent.ts` | Major update | **Critical** |
| `src/components/checkin/CheckInFlow.tsx` | Add time/event routing | High |
| `src/components/checkin/CheckInOptions.tsx` | Split or extend for both types | High |
| `src/app/today/page.tsx` | Remove reactive-only gate | High |
| `src/components/runtime/PlanScreen.tsx` | Default habitType handling | Medium |
| `src/lib/store/habitStore.ts` | Default habitType, consider repLogs migration | Medium |

---

## Reference

- **PRD Section:** "Logging System (Check-In Model)" ‚Äî describes both flows
- **PRD Section:** "Key Flows ‚Üí 3) Runtime Loop" ‚Äî specifies behavior by type
- **Design Doc:** `docs/design/logging_education_reflection.md` ‚Äî full specification