# M1 Feedback: Miss Flow Redesign — Form → Conversation

**Date:** February 5, 2026  
**Source:** Daily use testing, Day 4 (first miss)  
**Priority:** P1 — Core loop completeness

---

## Problem Statement

The miss flow is a legacy artifact from pre-LLM architecture. When a user misses a habit, they're routed through a static form ("What got in the way?") and a static recovery screen, instead of the conversational experience they've come to expect.

This breaks the conversational contract established everywhere else in the app.

**Current flow:**
```
Miss → Static form (4 options) → Static recovery screen → Home
```

**Problem:** The user just experienced a real moment (missing a habit), and instead of meeting them with the empathetic coach who's been with them for days, we hand them a multiple-choice quiz.

---

## Why This Matters

1. **Tone shift is jarring** — The reflection conversations are warm and specific. The miss form is cold and generic.

2. **Loses understanding** — "Didn't have time" tells us almost nothing. A conversation might reveal: "I had a work dinner that ran late and by the time I got home I just crashed" — which is actionable.

3. **Misses redesign opportunity** — A miss is often a signal that something in the system is fragile. The conversation is the moment to surface that and offer adjustments.

4. **Static recovery action may not fit** — The recovery action was designed during intake. After a real miss, the user might need something different. A conversation can adapt.

---

## Proposed Solution: Recovery Coach Conversation

Replace the static form + screen with an LLM-powered conversation using the "Recovery Coach" role from the PRD.

**New flow:**
```
Miss → Recovery conversation (LLM) → Home
```

### Conversation Goals

The Recovery Coach conversation should:

| Goal | How |
|------|-----|
| **Normalize without minimizing** | Acknowledge the streak they had, reassure that one miss doesn't reset progress |
| **Actually understand what happened** | Open question "What got in the way?" with follow-ups based on response |
| **Surface system fragility** | If context suggests the anchor/timing is wrong, probe: "Is evening still the right time for you?" |
| **Offer recovery action contextually** | Present the recovery action conversationally, confirm it still fits |
| **End with forward momentum** | Specific plan for tomorrow, not generic encouragement |

### Skip Option (Required)

The conversation should be **encouraged but skippable**. 

- Conversation starts automatically when user selects "Can't today"
- "Skip for now" option remains available throughout
- Goal is support, not interrogation
- If skipped, log the miss reason as "skipped" and return to home

---

## Prompt Design

### RECOVERY_COACH_PROMPT

```
You are the Habit Stacker AI in "Recovery Coach" mode. The user just missed their habit.

Context:
- Habit: {anchor} → {action}
- Recovery action: {recovery_action}
- Their streak before this: {days_completed} days
- Total reps: {total_reps}
- User's original goal: {goal_from_intake}
- User's original blocker: {blocker_from_intake}
- Miss reason selected (if any): {miss_reason}

## Your Role

You're here to support, not judge. A miss is normal — what matters is what happens next.

## Conversation Flow

1. OPEN with warmth
   - Acknowledge the miss without dwelling on it
   - Reference their progress ("You had 3 good days — that's real")
   
2. UNDERSTAND what happened
   - Ask what got in the way (open-ended, not multiple choice)
   - Listen for signals about system fragility (wrong time, wrong anchor, life circumstances)
   
3. PROBE if the system needs adjustment
   - If they mention timing issues: "Would a different time work better?"
   - If they mention forgetting: "Should we adjust the anchor to something more reliable?"
   - If it was a one-off: Acknowledge and move on
   
4. PRESENT the recovery action
   - Remind them of their recovery plan
   - Confirm it still feels right: "Does logging tomorrow morning still work, or would you rather just pick up at 8pm tomorrow?"
   
5. CLOSE with forward momentum
   - Specific plan for getting back on track
   - "See you tomorrow at [time]"

## Tone

- Warm, not clinical
- Brief, not lecture-y
- Curious, not interrogating
- Forward-looking, not dwelling on the miss

## DO NOT

- Make them feel guilty
- Use phrases like "That's okay, everyone fails sometimes" (patronizing)
- Lecture about the importance of consistency
- Require them to justify or explain themselves
- Push system changes if it was clearly a one-off

## Output Format

{
  "message": "Your response (2-4 sentences, conversational)",
  "suggestedReplies": ["Contextual option 1", "Option 2", "Skip for now"],
  "shouldClose": false,
  "systemChangeProposed": null // or { "field": "anchor", "suggestion": "morning" }
}
```

---

## Implementation Changes

### Files to Create

| File | Description |
|------|-------------|
| `src/lib/ai/prompts/recoveryCoachAgent.ts` | Recovery coach prompt and types |
| `src/app/api/recovery/stream/route.ts` | Streaming API endpoint for recovery conversation |

### Files to Modify

| File | Changes |
|------|---------|
| `src/components/checkin/CheckInFlow.tsx` | Route "Can't today" to recovery conversation instead of static form |
| `src/components/checkin/MissedFlow.tsx` | Replace static form with `RecoveryConversation` component (or repurpose `CheckInConversation` with mode flag) |
| `src/types/habit.ts` | Add `missReason` and `recoveryConversation` to CheckIn type |

### Component Options

**Option A: New RecoveryConversation component**
- Cleaner separation of concerns
- May duplicate some logic from CheckInConversation

**Option B: Extend CheckInConversation with `mode: 'reflection' | 'recovery'`**
- Reuses existing streaming/conversation infrastructure
- Pass mode to determine which prompt to use

Recommend **Option B** for faster implementation — the conversation UI is the same, only the prompt differs.

---

## Data Model Updates

```typescript
interface CheckIn {
  // existing fields...
  
  // For misses
  missed?: boolean;
  missReason?: string;  // From conversation, not form
  recoveryPlanConfirmed?: boolean;
  systemChangeProposed?: {
    field: 'anchor' | 'time' | 'action' | 'recovery';
    suggestion: string;
    accepted: boolean;
  };
}
```

---

## Example Conversation

**AI:** "Three days in a row, and then tonight didn't happen. That's completely normal — life gets in the way. What happened tonight?"

**User:** "Had a work dinner that ran way later than expected. By the time I got home I just wanted to sleep."

**AI:** "Makes sense — a late dinner throws off the whole evening routine. Is this a regular thing for you, or more of a one-off?"

**User:** "Maybe once a week I have something like this"

**AI:** "Worth noting. For nights like that, your recovery plan is to log the next morning before work. Does that still feel doable, or would you rather just pick up at 8pm tomorrow?"

**User:** "Morning works, I'll do it with coffee"

**AI:** "Perfect. Tomorrow morning with coffee — you're still on track. See you then."

---

## Success Criteria

- [ ] Miss triggers conversation, not static form
- [ ] Conversation understands and responds to specific user context
- [ ] Recovery action is presented conversationally and can be confirmed/adjusted
- [ ] User can skip conversation if not in the headspace
- [ ] System change suggestions are captured (for future use)
- [ ] Miss + conversation stored in check-in record
- [ ] Tone feels supportive, not interrogating

---

## Relationship to Other Feedback

This builds on R13 (Reflection upgrade) — same architectural pattern of replacing rule-based responses with LLM conversation. Can reuse streaming infrastructure and conversation UI components.