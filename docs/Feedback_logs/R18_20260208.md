# Habit Stacker: Post-Audit Implementation Plan

**Date:** 2026-02-08
**Author:** Product Advisory (for Claude Code handoff)
**Input:** Feature Audit (2025-02-08, commit `8bddeca`) + PRDs 1-3

---

## Context & Strategic Assessment

### What's Working

The M1 Alpha has a strong foundation. The conversational intake (Sonnet-powered), system confirmation with ritual reveal, daily runtime loop (done/miss/recover), journey tab with calendar visualization, and the daily check-in conversation are all built and functional. The core thesis â€” that conversational AI creates superior habit design experiences â€” has been validated through the intake flow.

### The Structural Gap

The audit correctly identifies that the **reflection â†’ system mutation feedback loop** is the critical missing piece. Here's why this matters beyond just "a missing feature":

The product thesis is that AI creates a continuous coaching relationship. Right now, the AI shows up brilliantly at intake, maintains presence through daily check-in conversations, but **never adapts the system based on what it learns**. The user's `HabitSystem` is frozen from the moment they confirm it. This means:

- Patterns surface insights but can't act on them
- Weekly reflection collects feedback but doesn't apply it
- The 4-week progression arc exists visually but nothing changes at stage boundaries
- The "Accept and update" button stores a date but doesn't modify the system

This creates a fundamentally static experience wearing a conversational costume. The data flows in (check-ins feed patterns, patterns feed reflection summaries) but nothing flows back out. The loop is open.

```
CURRENT STATE (open loop):
Check-ins â†’ Patterns â†’ Reflection â†’ [dead end]

TARGET STATE (closed loop):
Check-ins â†’ Patterns â†’ Reflection â†’ System Update â†’ Better check-ins
                                  â†’ Coach's Notes Update
                                  â†’ Stage Progression
                                  â†’ Graduation pathway
```

### Implementation Philosophy

Each phase delivers a complete, user-facing value increment â€” not "data model first, UI second." Every phase ships something a user would notice and benefit from immediately.

---

## Phase 1: Close the Feedback Loop

**Priority:** Critical â€” blocks everything else
**Effort:** ~1 day
**Goal:** Make the existing system actually adaptive

This is the single highest-leverage work available. Everything else in the app gets better once data flows back into the system.

### 1a. WeeklyReflection Data Model + Storage

Add the `WeeklyReflection` interface (well-spec'd in PRD 3):

```typescript
interface WeeklyReflection {
  id: string;
  weekNumber: number;           // Week 1, Week 2, etc.
  completedAt: string;          // ISO date
  sustainability: 'yes' | 'mostly' | 'no';
  friction: string | null;      // User's free text
  recommendation: {
    text: string;
    changes: string[];
    appliesTo: string;
    accepted: boolean;
    appliedAt?: string;
  };
  checkInsSummary: {
    completed: number;
    total: number;
    avgDifficulty: number;
    difficultyTrend: 'easier' | 'stable' | 'harder';
  };
}
```

Add to `HabitData`:

```typescript
interface HabitData {
  // ... existing fields
  reflections?: WeeklyReflection[];
  nextReflectionDue?: string;   // ISO date
}
```

This is pure plumbing but everything downstream depends on it.

### 1b. Home Screen Reflection Banner

Wire `useReflectionTrigger` (which already exists and detects the condition) to a visible banner on `PlanScreen`.

**Trigger conditions (already implemented in hook):**
- 7+ days since creation AND not reflected this week
- OR 3+ consecutive misses (recovery reflection variant)

**Banner spec:**
- Card on PlanScreen above the daily CTA
- Copy: "Week [N] check-in â€” How's your system working?" with CTA to `/reflect`
- "Remind me later" button: dismisses for 24 hours (store dismiss timestamp in localStorage)
- Auto-dismiss after 3 days (banner becomes stale)
- Recovery variant copy: "Let's talk â€” I noticed a few tough days"

**Key point:** Without this banner, the reflection feature is effectively hidden. Users must navigate manually to `/reflect`, which means they won't.

### 1c. System Mutation from "Accept and Update"

This is the one that closes the loop. When a user accepts a reflection recommendation:

1. Parse the recommendation's `appliesTo` field (`anchor`, `action`, `tiny_version`, `recovery`, `timing`)
2. Apply the corresponding change to `HabitSystem`
3. Log the change in `WeeklyReflection.recommendation.appliedAt`
4. Show a confirmation of what changed (before/after)
5. Store the previous values so patterns can do before/after comparison

**Mutation targets on HabitSystem:**

| `appliesTo` value | Field(s) modified |
|---|---|
| `anchor` | `anchor`, possibly `anchorTime` |
| `action` | `action` |
| `tiny_version` | `tinyVersion` (activates tiny version as primary) |
| `recovery` | `recovery` |
| `timing` | `anchorTime` or `checkInTime` |
| `none` | No system change (encouragement only) |

**Implementation note:** Create a generic `applySystemUpdate(habitSystem, changes)` function that both reflection and pattern actions can call. Don't duplicate mutation logic.

### 1d. Wire Pattern â†’ Action Buttons

The `onAction` callbacks in `PatternsSection.tsx` are already rendered (with buttons like "Adjust anchor" and "Use tiny version") but not connected. Wire them to the same `applySystemUpdate` function from 1c.

**Flow:**
1. User taps action button on a pattern insight
2. Show confirmation: "This will change your [anchor/tiny version/etc] to [new value]. Apply?"
3. On confirm, call `applySystemUpdate`
4. Log the change source as `pattern_suggestion` (vs `weekly_reflection`) for analytics

This gives users **two paths** to system adjustment: pattern suggestions (data-driven, bottom-up) and weekly reflection (conversational, top-down). Both should use the same underlying mutation mechanism.

---

## Phase 2: Upgrade Reflection Quality

**Priority:** High â€” directly serves product thesis
**Effort:** ~1 day
**Goal:** Replace form-based flows with conversational AI

The current `/reflect` is a 5-step form. This directly contradicts the "conversation is the hero" principle and the PRD spec ("continuation of consultation, not interrogation"). This phase upgrades the reflection experience to match the quality bar set by intake.

### 2a. AI-Powered Weekly Reflection Conversation

Replace the step-through form at `/reflect` with a conversational interface.

**Reuse:** `CheckInConversation.tsx` component patterns (chat interface, message animation, skip functionality).

**AI context window for reflection:**
- Current `HabitSystem` (full)
- This week's check-ins (outcomes, difficulty ratings, conversation snippets)
- Pattern analysis output (if 7+ reps)
- Previous reflection outcomes (if any)
- Current progression stage

**Conversation structure (AI-guided, not rigid steps):**
1. **Summary + opening:** "You've been at this for [N] days. [Brief stats]. How's the system feeling?"
2. **Sustainability probe:** Based on response, dig into what's working or what's hard
3. **Friction identification:** If friction exists, get specific about what and when
4. **Recommendation:** Generate ONE specific, actionable suggestion
5. **Confirmation:** "Accept and update" or "Not now" â€” both are valid

**AI prompt guidance:**
- Reference specific check-in data ("I noticed Friday was a miss â€” what happened?")
- Connect to identity ("You're building the identity of someone who...")
- Keep recommendations bounded: ONE change, never suggest adding more habits, never increase difficulty
- Tone: warm, curious, non-judgmental per design brief

**Output:** Structured `WeeklyReflection` object extracted from conversation, plus the raw conversation log.

### 2b. AI-Powered Recovery Reflection (3+ Consecutive Misses)

Same conversational upgrade for the recovery variant. This is where the "Recovery Coach" AI role earns its keep.

**Tone difference from weekly:** More empathetic, less structured. Lead with acknowledgment, not data.

**Opening:** "I noticed you've had a few tough days. That's not failure â€” it's information. What's been going on?"

**Possible outcomes (from PRD 2):**
- **Adjust system:** Modify anchor, simplify action, add toolkit items
- **Pause habit:** Put on hold with clear re-entry plan
- **Redesign:** Route back to intake for a different habit
- **Recommit:** Acknowledge the rough patch, continue with encouragement

**Implementation note:** Use `recoveryCoachAgent.ts` (already exists for daily recovery) as the base, but with expanded context and longer conversation allowance.

### 2c. Personalized Expandable Rationale (Education Layer 2)

Upgrade the generic "Why this approach works" collapsible on PlanScreen to the personalized 3-section format from PRD 2:

```
THE PRINCIPLE
[Domain science in accessible language]

WHY IT FITS YOU
[References specific details from intake conversation]

WHAT TO EXPECT
[Week-by-week expectations based on domain knowledge]
```

**Generation:** This content should be generated during intake (the context is already captured) and stored in `HabitSystem`. Add fields:

```typescript
interface HabitSystem {
  // ... existing fields

  // Education Layer 2 (generated from intake)
  rationale?: {
    principle: string;
    whyItFitsYou: string;
    whatToExpect: string;
  };
}
```

**Surfacing:** Replace the current generic collapsible with this personalized version. Include "Read more in Coach's Notes â†’" link at the bottom (when Coach's Notes is built in Phase 4).

---

## Phase 3: Progressive Enrichment

**Priority:** Medium-High â€” makes the app feel alive over time
**Effort:** ~1-2 days
**Goal:** Features that reward continued engagement and make the app grow with the user

### 3a. Stage Transition Moments

At Week 1â†’2, Week 2â†’3, Week 3â†’4 boundaries, trigger a special experience:

**Detection:** Calculate stage based on calendar days (not just rep count â€” the current implementation uses `repsCount` which doesn't account for time). Add `currentStage` to `HabitSystem` and update it when boundary is crossed.

**Stage boundaries:**
- Week 1 complete: 7 calendar days since habit creation
- Week 2 complete: 14 calendar days
- Week 4 complete: 28 calendar days

**Transition flow (per PRD 2):**
1. **Celebration screen:** "Week [N] complete" with summary stats
2. **Next phase briefing:** What the focus shifts to (e.g., "Week 2: Protect the Habit â€” notice what threatens it")
3. **Optional reflection:** "I want to reflect on Week [N] first" â†’ routes to weekly reflection
4. **Progression unlock:** Update `ProgressionSection.tsx` to highlight newly active stage

**Progressive disclosure fix:** Currently the progression section shows immediately in the Self tab. Gate it behind Week 1 completion per PRD rules. Before Week 1, show a placeholder: "Your progression arc will appear after your first week."

### 3b. Pattern History + Caching

Currently patterns regenerate on every render via `insightGenerator.ts`. This is wasteful and prevents longitudinal analysis.

**Changes:**
1. Cache generated patterns with a timestamp
2. Regenerate weekly (not on every render)
3. Store historical pattern snapshots in `HabitData`
4. Enable longitudinal insights: "Your difficulty has been dropping for 3 weeks" or "Weekend completion improved after your anchor adjustment"

```typescript
interface PatternSnapshot {
  id: string;
  generatedAt: string;
  insights: PatternInsight[];
  suggestion?: PatternSuggestion;
  checkInCount: number;  // How many check-ins this was based on
}

interface HabitData {
  // ... existing fields
  patternHistory?: PatternSnapshot[];
  latestPatternGeneratedAt?: string;
}
```

### 3c. On-Demand Reflection ("Talk to Coach")

Wire the "..." menu button on PlanScreen to functional options:

```
â‹® Menu
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Talk to coach â†’     // Opens conversational AI interface
Pause for now       // Pauses habit with re-entry plan
Redesign habit      // Routes back to intake
Delete and start over
```

**"Talk to coach" flow:**
1. Show intent selection: "What's on your mind?" with options from PRD 2:
   - "I want to make the habit easier"
   - "I want to make it harder/more ambitious"
   - "I'm not sure this is the right habit"
   - "Something else"
2. Route to conversational AI with the selected intent as context
3. AI has access to: current system, recent check-ins, patterns, reflection history
4. Outcome: may result in system update (same mutation path as reflection)

**Log as:** `type: 'on_demand'` in reflection history.

### 3d. Toolkit Surfacing

The fields exist in `HabitSystem` (`tinyVersion`, `environmentPrime`, `frictionReduced`) but aren't surfaced as a dedicated section.

**Implementation:**
- Add a "Your Toolkit" card under the System tab
- Show after first tune-up or after any reflection that modifies toolkit fields
- Display: Tiny Version, Environment Prime, Friction Reduced â€” with brief explanations
- Each item editable (tapping opens inline edit or routes to reflection)

---

## Phase 4: AI-Generated Patterns

**Priority:** Medium â€” upgrades existing rule-based system
**Effort:** ~0.5 day
**Goal:** Replace rule-based pattern generation with AI-generated insights

### Current State

`insightGenerator.ts` uses deterministic rules (day-of-week analysis, difficulty trends, miss counting) to generate pattern cards. This works but produces generic, repetitive insights.

### Target State

Use an LLM to generate pattern analysis from the same data, producing more nuanced, personalized, and actionable insights.

**AI prompt structure (from PRD 3):**

```
You are the Pattern Finder for a habit tracking app. Analyze the user's
check-in history and generate 2-3 insights plus one specific suggestion.

USER'S HABIT SYSTEM:
{habitSystem}

CHECK-IN HISTORY (last 14 days):
{checkInHistory â€” including outcomes, difficulty, conversation snippets, timestamps}

PREVIOUS PATTERNS (if any):
{previousPatternSnapshot}

RULES:
1. Maximum 3 insights
2. One must be positive (what's working)
3. One can be watchful (what to monitor)
4. Exactly one actionable suggestion
5. Never suggest adding more habits
6. Never suggest increasing difficulty in Week 1-2
7. Reference specific data points ("Friday was your only miss")
8. Connect to identity when natural

OUTPUT FORMAT:
{
  "insights": [
    { "type": "positive" | "watchful" | "neutral", "text": "..." },
  ],
  "suggestion": {
    "text": "...",
    "appliesTo": "anchor" | "action" | "tiny_version" | "recovery" | "timing" | "none",
    "requiresSystemUpdate": boolean,
    "changes": ["..."]
  },
  "summary": "One sentence overall assessment"
}
```

**Implementation approach:**
1. Keep the rule-based `insightGenerator.ts` as a fallback (for when AI is slow or fails)
2. Add `aiPatternGenerator.ts` that calls Sonnet with the above prompt
3. Generate weekly, cache the result (per Phase 3b)
4. Compare AI quality vs rule-based during your own testing before defaulting to AI

**Model choice:** Start with Sonnet for quality. Pattern generation happens weekly (not per-interaction), so latency and cost are less of a concern than for daily check-in conversations.

**Data needed per generation:**
- Full `HabitSystem`
- Last 14 days of check-ins (outcomes, difficulty, conversation text, timestamps)
- Previous pattern snapshot (for longitudinal comparison)
- Reflection history (for before/after system change analysis)

---

## Phase 5: Coach's Notes (Education Layer 3)

**Priority:** Medium â€” rich engagement feature, strengthens coaching relationship
**Effort:** ~0.5-1 day
**Goal:** Personalized reference document that deepens the user's understanding and serves as motivation anchor

### What It Is

A dedicated page accessible from the System tab â€” a personalized document that explains:
- Why this specific habit was recommended (not another)
- The science behind the approach in accessible language
- What to expect week-by-week
- How to explain the system to others

Think of it as the "case notes" a therapist might keep â€” except the client can read them.

### Why It Matters

Coach's Notes serves three purposes:
1. **Motivation anchor** â€” When commitment wavers, users can revisit *why* this matters
2. **Social proof tool** â€” Users can show others their system rationale ("my coach recommended this because...")
3. **Knowledge transfer** â€” Builds user competence so they're less dependent on the AI over time

### Content Structure (from PRD 2)

```
COACH'S NOTES

Based on our conversation on [date], here's my understanding of
your situation and why I recommended this approach.

---

THE PATTERN I NOTICED
[Synthesis of what the AI learned during intake â€” the user's
specific situation, triggers, and history]

WHY THIS HABIT (NOT ANOTHER)
[Explains what alternatives were considered and why this specific
behavior was chosen. Makes the user feel the recommendation was
thoughtful, not random.]

THE SCIENCE IN 60 SECONDS
[Domain science behind the approach, written for a smart
non-expert. Accessible but not dumbed down.]

WHAT TO WATCH FOR
[Common pitfalls for this specific habit type, personalized
to the user's stated blockers]

YOUR EDGE
[What about the user's situation makes them well-positioned
to succeed â€” reframes strengths from intake conversation]

---
Last updated based on our conversation [date]
This will update after your weekly reflection.
```

### Generation

**Initial generation:** During intake, after system confirmation. The intake conversation transcript + habit system provides all the context needed.

**Storage:**

```typescript
interface HabitSystem {
  // ... existing fields

  coachNotes?: {
    generatedAt: string;
    lastUpdatedAt: string;
    patternNoticed: string;
    whyThisHabit: string;
    scienceIn60Seconds: string;
    whatToWatchFor: string;
    yourEdge: string;
    addenda?: CoachNotesAddendum[];  // Updates from reflections
  };
}

interface CoachNotesAddendum {
  addedAt: string;
  source: 'weekly_reflection' | 'recovery_reflection' | 'stage_transition';
  content: string;  // e.g., "After Week 1, we identified cold rooms as a barrier..."
}
```

**Updates:** After each weekly reflection or recovery reflection, append an addendum that captures new insights. The AI can reference previous Coach's Notes content when generating reflection responses.

### Surfacing

- Accessible from System tab: "Coach's Notes â†’" link
- Also linked from the expandable rationale (Layer 2): "Read more in Coach's Notes â†’"
- **Progressive disclosure:** Available immediately after intake (it's generated from intake data), but only *surfaced* (prompted) after the user taps "Why this works" for the first time

### AI Prompt for Generation

```
You are generating Coach's Notes for a habit coaching app. These notes
are written FROM the coach TO the user â€” they should feel personal,
insightful, and motivating.

INTAKE CONVERSATION:
{conversationTranscript}

HABIT SYSTEM DESIGNED:
{habitSystem}

Write the following sections. Be specific â€” reference things the user
actually said. Write as if you know this person.

1. THE PATTERN I NOTICED (2-3 sentences)
2. WHY THIS HABIT (NOT ANOTHER) (3-4 sentences, mention at least one
   alternative you considered and why you chose differently)
3. THE SCIENCE IN 60 SECONDS (4-5 sentences, cite the approach name
   if applicable)
4. WHAT TO WATCH FOR (2-3 bullet points, specific to their situation)
5. YOUR EDGE (2 sentences, genuinely encouraging, not generic)
```

---

## Phase 6: Graduation & Multi-Habit Architecture

**Priority:** Medium â€” required for M2+ but needs careful design thinking
**Effort:** ~1-2 days (architecture + initial implementation)
**Goal:** Define how habits complete, how new ones start, and how the system scales beyond one habit

### The Design Challenge

Law 1 states: "One active habit. Exactly one habit at a time." This is correct for M1 â€” focus is essential for habit formation. But it creates three questions the current system can't answer:

1. **When is a habit "done"?** â€” What does graduation look like?
2. **What happens after graduation?** â€” How does the user pick their next habit?
3. **What's the relationship between habits?** â€” Does the old habit just disappear?

### Mental Model: Habit Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HABIT LIFECYCLE                            â”‚
â”‚                                                              â”‚
â”‚  ACTIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚
â”‚  (one at a time, full coaching support)                      â”‚
â”‚                                                              â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚      â”‚  Week 1  â”‚â”€â”€â”€â–ºâ”‚ Week 2-4 â”‚â”€â”€â”€â–ºâ”‚ Month 2+ â”‚          â”‚
â”‚      â”‚ Show Up  â”‚    â”‚ Stabilizeâ”‚    â”‚  Expand  â”‚          â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                            â”‚                 â”‚
â”‚                                            â–¼                 â”‚
â”‚  GRADUATION CHECKPOINT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚
â”‚  "Is this automatic enough to maintain while                â”‚
â”‚   starting something new?"                                   â”‚
â”‚                                            â”‚                 â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                              â–¼                             â–¼ â”‚
â”‚                        NOT YET                        GRADUATEâ”‚
â”‚                     (continue active)              (move to  â”‚
â”‚                                                    maintained)â”‚
â”‚                                                              â”‚
â”‚  MAINTAINED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚
â”‚  (lightweight tracking, periodic check-in, no daily coach)  â”‚
â”‚                                                              â”‚
â”‚  PAUSED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚
â”‚  (user-initiated break, clear re-entry plan)                â”‚
â”‚                                                              â”‚
â”‚  ARCHIVED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚
â”‚  (completed or abandoned, visible in history)               â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Graduation Criteria

A habit is ready for graduation when:
- **Minimum time:** 4+ weeks active (enough for neural pathway formation)
- **Consistency signal:** 80%+ completion rate in the last 2 weeks
- **Difficulty signal:** Average difficulty â‰¤ 2 in the last week (it feels easy)
- **User confirmation:** The system suggests graduation, user confirms

**Graduation is never automatic.** The AI suggests it; the user decides.

### Graduation Flow

```
AI (at stage transition or weekly reflection):

"You've been doing this for [N] weeks. Your completion rate is [X]%
and your difficulty has dropped to [Y]. This is starting to look
automatic.

Are you ready to graduate this habit and start maintaining it
while we work on something new?"

Options:
[Yes, I'm ready to move on]
[Not yet â€” I want another week]
[I want to make this harder first]
```

**If graduated:**
1. Habit moves to `maintained` status
2. Brief celebration moment
3. Transition to "What's next?" flow (exploration or new intake)
4. Maintained habit gets lightweight weekly check-in (not daily)

### Data Model for Multi-Habit

```typescript
// Extend HabitState
type HabitState =
  | 'onboarding'
  | 'active'        // Full coaching support, daily check-in
  | 'maintained'    // Graduated â€” lightweight tracking
  | 'paused'        // User-initiated break
  | 'archived';     // Completed or abandoned

interface HabitData {
  // ... existing fields
  state: HabitState;
  graduatedAt?: string;
  pausedAt?: string;
  pauseReason?: string;
  reentryPlan?: string;  // For paused habits
}

// New: Multi-habit container
interface UserHabits {
  activeHabit?: HabitData;           // At most ONE active
  maintainedHabits: HabitData[];     // Graduated, lightweight tracking
  pausedHabits: HabitData[];         // On hold
  archivedHabits: HabitData[];       // History
  habitBacklog?: HabitBacklogItem[]; // Future intentions
}

interface HabitBacklogItem {
  id: string;
  description: string;        // "Exercise more", "Read before bed"
  addedAt: string;
  source: 'intake' | 'reflection' | 'manual';  // Where this came from
  priority?: number;
}
```

### Maintained Habits: Lightweight Tracking

Once graduated, a habit doesn't disappear â€” it moves to a lower-touch mode:

- **No daily check-in conversation** (the behavior should be automatic)
- **Weekly pulse check:** "Still doing [habit]?" with Yes/Mostly/Slipped options
- **Re-activation trigger:** If the user reports "Slipped" 2+ times, offer to re-activate for coaching
- **Visible in Journey tab:** Maintained habits show as a quieter track alongside the active habit

### The "What's Next?" Experience

After graduation, the user enters a brief exploration phase:

```
WHAT'S NEXT?

You mentioned during setup that you also wanted to work on:
â€¢ "Reading more"          [captured from intake backlog]
â€¢ "Morning exercise"      [captured from reflection]

Or we can explore something completely new.

[Work on: Reading more]
[Work on: Morning exercise]
[Explore something new â†’]  // Routes to fresh intake conversation
```

**Backlog population:** Throughout the habit lifecycle, the AI should capture mentions of other goals:
- During intake: "I also want to..." â†’ add to backlog
- During reflections: "Now that sleep is better, I want to tackle..." â†’ add to backlog
- Manual: User can add items anytime

### Navigation Impact

With multi-habit support, the home screen needs to accommodate:

```
/today (HOME)

ACTIVE HABIT (dominant)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Full daily experience as current]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

MAINTAINED (subtle, below active)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸŸ¢ Sleep Protocol  Â·  Week 8  Â·  On track  â”‚
â”‚  Last checked: 2 days ago                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key principle:** The active habit always dominates the screen. Maintained habits are visible but never compete for attention. Law 5 (one clear next step) still applies â€” the CTA is always for the active habit.

### Implementation Sequencing for Multi-Habit

**Phase 6a (do now):** Add `HabitState` to data model. Add `state: 'active'` to existing habits. This is backward-compatible and sets up the architecture without changing any UX.

**Phase 6b (do now):** Implement graduation detection logic. At the Month 2+ stage boundary (or at weekly reflections after 4 weeks), check graduation criteria and surface the suggestion.

**Phase 6c (do now):** Implement the graduation flow â€” celebration, maintained-state transition, "What's next?" screen.

**Phase 6d (M2):** Implement maintained-habit lightweight tracking (weekly pulse check).

**Phase 6e (M2):** Implement habit backlog capture (during intake and reflections) and the "What's next?" exploration experience.

**Phase 6f (M3):** Full multi-habit navigation, maintained-habit re-activation, cross-habit pattern analysis.

---

## Deferred Items (M3+)

These remain out of scope for now:

- **Photo Log / Evidence Gallery** â€” Nice engagement feature but doesn't serve the core thesis
- **Conversation timeout** (30-second gentle prompt) â€” Nice polish, not blocking anything
- **Frequency / Avoidance habit types** â€” Correctly scoped out of M1
- **Full navigation restructure** â€” The tab structure in the PRD is a good north star, but reorganizing navigation is high-effort, low-insight work at the alpha stage. Get the feedback loop working first â€” navigation can be tuned for M2 when other people need to find things intuitively

---

## Implementation Sequence Summary

| Phase | Effort | What Ships | Depends On |
|-------|--------|------------|------------|
| **1: Close the Loop** | ~1 day | WeeklyReflection data model, home screen banner, system mutation, patternâ†’action wiring | Nothing (start here) |
| **2: Upgrade Reflection Quality** | ~1 day | AI-powered weekly + recovery reflection, personalized rationale | Phase 1 (mutation infrastructure) |
| **3: Progressive Enrichment** | ~1-2 days | Stage transitions, pattern caching, on-demand coach, toolkit surfacing | Phase 1 (data model) |
| **4: AI-Generated Patterns** | ~0.5 day | LLM-powered pattern analysis replacing rule-based | Phase 3b (pattern caching) |
| **5: Coach's Notes** | ~0.5-1 day | Personalized reference document, reflection-driven updates | Phase 2 (reflection infrastructure) |
| **6: Graduation & Multi-Habit** | ~1-2 days | Habit lifecycle states, graduation flow, "What's next?", backlog | Phase 1 + 3a (stage transitions) |

**Total estimated effort:** ~5-7 days

### Recommended Order of Operations

```
Week 1:  Phase 1 (Close the Loop) â†’ Phase 2 (Upgrade Reflections)
Week 2:  Phase 3 (Progressive Enrichment) â†’ Phase 4 (AI Patterns)
Week 3:  Phase 5 (Coach's Notes) â†’ Phase 6a-c (Graduation foundations)
Ongoing: Phase 6d-f (Multi-habit polish, maintained tracking)
```

Phases 1 and 2 are the M2 readiness gate â€” they're what make the difference between "try my app" and "use my app for 2 weeks and tell me if the AI coaching works." Phases 3-5 sustain engagement through a full month. Phase 6 opens the door to long-term retention and the second-habit moment.

---

## Key Design Principles (For Claude Code Reference)

These should guide implementation decisions when the specs above are ambiguous:

1. **Conversation is the hero** â€” When in doubt, make it conversational, not form-based
2. **One mutation path** â€” All system updates (from patterns, reflections, on-demand) should use the same `applySystemUpdate` function
3. **Progressive disclosure** â€” Don't show features before there's data to make them meaningful
4. **Anti-punitive** â€” Language should never frame misses as failure. "That's data, not failure."
5. **Warm Minimalism** â€” Per design brief: Fraunces headings, Outfit body, warm cream backgrounds, deep teal accents, no gradients, no bouncy animations
6. **Law 1 still holds** â€” Even with multi-habit architecture, exactly one habit is "active" at a time. Maintained habits are background, not foreground.
7. **AI quality over speed** â€” For weekly/infrequent interactions (reflections, patterns, Coach's Notes), use Sonnet. For daily interactions (check-in conversation), test Haiku vs Sonnet for the right speed/quality tradeoff.

---

## Reference: PRD Sources

| PRD | File | Key Sections Referenced |
|-----|------|----------------------|
| 1 | `docs/PRD_overall.md` | Navigation architecture, progressive disclosure rules, product laws, data model |
| 2 | `docs/PRD_logging_education_reflection_systems.md` | Education 3-layer architecture, Coach's Notes spec, reflection cycles, stage transitions |
| 3 | `docs/PRD_tracking_reflections_loop.md` | Daily check-in conversation, patterns system, weekly reflection flow, data models |

## Reference: Feature Audit

The full feature audit (commit `8bddeca`, 2025-02-08) should be consulted for:
- Exact file locations of existing implementations
- Current state of each PARTIAL feature
- Complete list of NOT BUILT items